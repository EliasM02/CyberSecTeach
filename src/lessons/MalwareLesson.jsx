import { useState } from 'react'
import { motion, AnimatePresence } from 'framer-motion'
import LessonLayout from '../components/LessonLayout'
import StepExplainer from '../components/StepExplainer'
import './MalwareLesson.css'

/* ‚Äî Simulated malware sample ‚Äî */
const SAMPLE = {
    name: 'invoice_2024.pdf.exe',
    sha256: 'a3f1b2c4d5e6f7890123456789abcdef0123456789abcdef0123456789abcdef',
    size: '245 KB',
    type: 'PE32 executable (GUI) Intel 80386',
    packer: 'UPX 3.96',
}

const STATIC_FINDINGS = [
    { id: 'imports', label: 'Suspicious Imports', severity: 'high', detail: 'WinExec, URLDownloadToFileA, VirtualAlloc, CreateRemoteThread', note: 'These APIs allow code execution, downloading files, and injecting into other processes.' },
    { id: 'strings', label: 'Suspicious Strings', severity: 'critical', detail: 'hxxps://evil-c2[.]ru/beacon, cmd.exe /c, HKLM\\Software\\Microsoft\\Windows\\CurrentVersion\\Run', note: 'C2 server URL, command execution, and persistence via registry.' },
    { id: 'entropy', label: 'High Entropy Sections', severity: 'medium', detail: '.text section entropy: 7.89 / 8.00', note: 'High entropy suggests packed or encrypted code ‚Äî malware often uses this to evade detection.' },
    { id: 'packer', label: 'Packer Detected', severity: 'medium', detail: 'UPX 3.96 ‚Äî executable is compressed/obfuscated', note: 'Packers compress the binary, making static analysis harder. Unpack before deeper analysis.' },
]

const DYNAMIC_EVENTS = [
    { time: '0.0s', event: 'Process created', detail: 'invoice_2024.pdf.exe (PID 4892)', type: 'process', severity: 'info' },
    { time: '0.2s', event: 'Registry modified', detail: 'HKLM\\..\\Run\\UpdateService = "C:\\Users\\...\\invoice_2024.pdf.exe"', type: 'persistence', severity: 'high' },
    { time: '0.5s', event: 'File written', detail: 'C:\\Users\\AppData\\Local\\Temp\\payload.dll (189 KB)', type: 'file', severity: 'high' },
    { time: '0.8s', event: 'DNS query', detail: 'evil-c2.ru ‚Üí 185.220.101.42', type: 'network', severity: 'critical' },
    { time: '1.1s', event: 'HTTP POST', detail: 'POST /beacon HTTP/1.1 ‚Üí 185.220.101.42:443 (encrypted)', type: 'network', severity: 'critical' },
    { time: '1.5s', event: 'Process injection', detail: 'CreateRemoteThread into svchost.exe (PID 1204)', type: 'injection', severity: 'critical' },
    { time: '2.0s', event: 'Scheduled task', detail: 'schtasks /create /sc minute /mo 5 /tn "WinUpdate"', type: 'persistence', severity: 'high' },
    { time: '3.0s', event: 'Data exfiltration', detail: 'POST /exfil ‚Äî 2.3 MB encrypted upload to C2', type: 'network', severity: 'critical' },
]

const IOC_DATA = [
    { type: 'SHA256', value: SAMPLE.sha256 },
    { type: 'C2 Domain', value: 'evil-c2[.]ru' },
    { type: 'C2 IP', value: '185.220.101.42' },
    { type: 'File Path', value: 'C:\\Users\\AppData\\Local\\Temp\\payload.dll' },
    { type: 'Registry', value: 'HKLM\\..\\Run\\UpdateService' },
    { type: 'Scheduled Task', value: 'WinUpdate (every 5 min)' },
]

const steps = [
    {
        title: 'What is Malware Analysis?',
        description: 'Malware analysis is the process of understanding how malicious software works ‚Äî what it does, how it spreads, and how to stop it. There are two main approaches: static analysis (examining the code without running it) and dynamic analysis (running it in a sandbox).',
    },
    {
        title: 'Static Analysis',
        description: 'We examine the file\'s metadata, strings, imports, and entropy WITHOUT executing it. This is safe but gives us limited information ‚Äî like reading the ingredient list on a package without tasting it.',
    },
    {
        title: 'Dynamic Analysis',
        description: 'Now we detonate the sample in a sandbox ‚Äî a controlled environment. We watch what it does: files created, network connections, registry changes, and process injection. Like putting it in a glass cage and watching it act.',
    },
    {
        title: 'Indicators of Compromise (IOCs)',
        description: 'From our analysis, we extract IOCs ‚Äî fingerprints of the malware. These include file hashes, C2 server IPs/domains, registry keys, and file paths. These are shared with the community to help others detect the same threat.',
    },
    {
        title: 'Defense & Tools',
        description: 'Real analysts use tools like IDA Pro, Ghidra, x64dbg, and sandbox platforms like ANY.RUN, VirusTotal, and Cuckoo Sandbox. Defense includes EDR systems, YARA rules, and threat intelligence sharing.',
    },
]

export default function MalwareLesson() {
    const [phase, setPhase] = useState('overview')  // overview | static | dynamic | ioc | defense
    const [currentStep, setCurrentStep] = useState(0)
    const [revealedFindings, setRevealedFindings] = useState([])
    const [dynamicProgress, setDynamicProgress] = useState(0)
    const [dynamicRunning, setDynamicRunning] = useState(false)
    const [iocCopied, setIocCopied] = useState(null)

    const startStatic = () => {
        setPhase('static')
        setCurrentStep(1)
    }

    const revealFinding = (id) => {
        if (!revealedFindings.includes(id)) {
            setRevealedFindings(prev => [...prev, id])
        }
    }

    const startDynamic = () => {
        setPhase('dynamic')
        setCurrentStep(2)
        setDynamicRunning(true)
        setDynamicProgress(0)

        // Auto-advance sandbox events
        let i = 0
        const interval = setInterval(() => {
            i++
            setDynamicProgress(i)
            if (i >= DYNAMIC_EVENTS.length) {
                clearInterval(interval)
                setDynamicRunning(false)
            }
        }, 800)
    }

    const showIOCs = () => {
        setPhase('ioc')
        setCurrentStep(3)
    }

    const showDefense = () => {
        setPhase('defense')
        setCurrentStep(4)
    }

    const copyIOC = (val) => {
        navigator.clipboard?.writeText(val)
        setIocCopied(val)
        setTimeout(() => setIocCopied(null), 1500)
    }

    const reset = () => {
        setPhase('overview')
        setCurrentStep(0)
        setRevealedFindings([])
        setDynamicProgress(0)
        setDynamicRunning(false)
    }

    const sidebar = <StepExplainer steps={steps} currentStep={currentStep} />

    return (
        <LessonLayout
            title="Malware Analysis"
            subtitle="Dissect the virus ‚Äî safely"
            sidebar={sidebar}
        >
            <div className="mal-scene">
                {/* Phase: Overview */}
                {phase === 'overview' && (
                    <motion.div className="mal-overview" initial={{ opacity: 0 }} animate={{ opacity: 1 }}>
                        <div className="mal-sample-card">
                            <div className="mal-sample-header">
                                <span className="mal-sample-icon">ü¶†</span>
                                <div>
                                    <div className="mal-sample-name">{SAMPLE.name}</div>
                                    <div className="mal-sample-meta">{SAMPLE.type} ‚Ä¢ {SAMPLE.size}</div>
                                </div>
                                <span className="mal-sample-badge">SUSPICIOUS</span>
                            </div>
                            <div className="mal-sample-details">
                                <div className="mal-detail-row">
                                    <span className="mal-detail-label">SHA256</span>
                                    <code className="mal-detail-hash">{SAMPLE.sha256}</code>
                                </div>
                                <div className="mal-detail-row">
                                    <span className="mal-detail-label">Packer</span>
                                    <code>{SAMPLE.packer}</code>
                                </div>
                            </div>
                        </div>
                        <motion.button className="mal-btn mal-btn-primary" onClick={startStatic} whileHover={{ scale: 1.05 }} whileTap={{ scale: 0.95 }}>
                            üî¨ Begin Static Analysis
                        </motion.button>
                    </motion.div>
                )}

                {/* Phase: Static */}
                {phase === 'static' && (
                    <motion.div className="mal-static" initial={{ opacity: 0 }} animate={{ opacity: 1 }}>
                        <h3 className="mal-section-title">üî¨ Static Analysis Results</h3>
                        <div className="mal-findings">
                            {STATIC_FINDINGS.map(f => (
                                <div key={f.id} className={`mal-finding ${revealedFindings.includes(f.id) ? 'mal-finding-open' : ''}`}>
                                    <button className="mal-finding-header" onClick={() => revealFinding(f.id)}>
                                        <span className={`mal-severity mal-severity-${f.severity}`}>{f.severity.toUpperCase()}</span>
                                        <span className="mal-finding-label">{f.label}</span>
                                        <span className="mal-finding-toggle">{revealedFindings.includes(f.id) ? '‚ñæ' : '‚ñ∏'}</span>
                                    </button>
                                    <AnimatePresence>
                                        {revealedFindings.includes(f.id) && (
                                            <motion.div className="mal-finding-body" initial={{ height: 0, opacity: 0 }} animate={{ height: 'auto', opacity: 1 }} exit={{ height: 0, opacity: 0 }}>
                                                <code className="mal-finding-detail">{f.detail}</code>
                                                <p className="mal-finding-note">{f.note}</p>
                                            </motion.div>
                                        )}
                                    </AnimatePresence>
                                </div>
                            ))}
                        </div>
                        <motion.button className="mal-btn mal-btn-primary" onClick={startDynamic} whileHover={{ scale: 1.05 }} whileTap={{ scale: 0.95 }}>
                            üí£ Detonate in Sandbox
                        </motion.button>
                    </motion.div>
                )}

                {/* Phase: Dynamic */}
                {phase === 'dynamic' && (
                    <motion.div className="mal-dynamic" initial={{ opacity: 0 }} animate={{ opacity: 1 }}>
                        <h3 className="mal-section-title">
                            üí£ Dynamic Analysis ‚Äî Sandbox
                            {dynamicRunning && <span className="mal-running"> ‚óè RUNNING</span>}
                        </h3>
                        <div className="mal-timeline">
                            {DYNAMIC_EVENTS.slice(0, dynamicProgress).map((ev, i) => (
                                <motion.div
                                    key={i}
                                    className={`mal-event mal-event-${ev.severity}`}
                                    initial={{ opacity: 0, x: -20 }}
                                    animate={{ opacity: 1, x: 0 }}
                                >
                                    <span className="mal-event-time">{ev.time}</span>
                                    <span className={`mal-event-type mal-event-type-${ev.type}`}>{ev.type}</span>
                                    <span className="mal-event-name">{ev.event}</span>
                                    <code className="mal-event-detail">{ev.detail}</code>
                                </motion.div>
                            ))}
                        </div>
                        {!dynamicRunning && dynamicProgress >= DYNAMIC_EVENTS.length && (
                            <motion.button className="mal-btn mal-btn-primary" onClick={showIOCs} whileHover={{ scale: 1.05 }} whileTap={{ scale: 0.95 }} initial={{ opacity: 0 }} animate={{ opacity: 1 }}>
                                üìã Extract IOCs
                            </motion.button>
                        )}
                    </motion.div>
                )}

                {/* Phase: IOCs */}
                {phase === 'ioc' && (
                    <motion.div className="mal-ioc" initial={{ opacity: 0 }} animate={{ opacity: 1 }}>
                        <h3 className="mal-section-title">üìã Indicators of Compromise (IOCs)</h3>
                        <p className="mal-ioc-desc">
                            These are the fingerprints we extracted. Share them with your team and threat intel platforms.
                        </p>
                        <div className="mal-ioc-table">
                            {IOC_DATA.map((ioc, i) => (
                                <div key={i} className="mal-ioc-row">
                                    <span className="mal-ioc-type">{ioc.type}</span>
                                    <code className="mal-ioc-value">{ioc.value}</code>
                                    <button className="mal-ioc-copy" onClick={() => copyIOC(ioc.value)}>
                                        {iocCopied === ioc.value ? '‚úì' : 'üìã'}
                                    </button>
                                </div>
                            ))}
                        </div>
                        <motion.button className="mal-btn mal-btn-primary" onClick={showDefense} whileHover={{ scale: 1.05 }} whileTap={{ scale: 0.95 }}>
                            üõ°Ô∏è Defense & Tools
                        </motion.button>
                    </motion.div>
                )}

                {/* Phase: Defense */}
                {phase === 'defense' && (
                    <motion.div className="mal-defense" initial={{ opacity: 0 }} animate={{ opacity: 1 }}>
                        <h3 className="mal-section-title">üõ°Ô∏è Defense & Analysis Tools</h3>
                        <div className="mal-defense-grid">
                            <div className="mal-defense-card">
                                <div className="mal-defense-label">Static Analysis</div>
                                <code>IDA Pro, Ghidra, PE-bear, strings, file</code>
                                <p>Disassemble binaries, inspect headers, and find hidden strings without executing the malware.</p>
                            </div>
                            <div className="mal-defense-card">
                                <div className="mal-defense-label">Dynamic Analysis</div>
                                <code>ANY.RUN, Cuckoo Sandbox, x64dbg, Procmon</code>
                                <p>Run malware in controlled environments to observe its behavior in real time.</p>
                            </div>
                            <div className="mal-defense-card">
                                <div className="mal-defense-label">Detection Rules</div>
                                <code>YARA rules, Snort/Suricata, Sigma</code>
                                <p>Write pattern-matching rules to detect this malware family across your infrastructure.</p>
                            </div>
                            <div className="mal-defense-card">
                                <div className="mal-defense-label">Threat Intelligence</div>
                                <code>VirusTotal, MISP, AlienVault OTX</code>
                                <p>Share IOCs with the community so everyone can detect and block this threat.</p>
                            </div>
                        </div>
                        <motion.button className="mal-btn mal-btn-reset" onClick={reset} whileHover={{ scale: 1.05 }} whileTap={{ scale: 0.95 }}>
                            ‚Üª Analyze Again
                        </motion.button>
                    </motion.div>
                )}
            </div>
        </LessonLayout>
    )
}
